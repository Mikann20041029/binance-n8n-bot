binance 自動化

 「現在私が作っているのは
AIによる binanceの自動化です。
指示が言ったとき、
binance apiを使用し、
12銘柄(BTCUSDT,ETHUSDT,BNBUSDT,SOLUSDT,XRPUSDT,ADAUSDT,DOGEUSDT,AVAXUSDT,LINKUSDT,MATICUSDT,TRXUSDT,DOTUSDT)についてデータ「① 価格そのもの（必須・最重要）
	•	現在価格（last / mark / index）
	•	過去N本のOHLCV（複数時間軸）
	•	1m / 5m / 15m / 1h / 4h / 1d
	•	高値・安値・終値の推移
	•	ギャップ（急変点）
	•	ボラティリティ（ATR / 標準偏差）

⸻

② 出来高・流動性
	•	各時間軸の出来高
	•	出来高移動平均
	•	出来高スパイク検知
	•	約定量の増減率
	•	流動性（板の厚さ）

⸻

③ オーダーブック（極めて重要）
	•	上位N段のBid/Ask数量
	•	板の不均衡（Bid/Ask比率）
	•	壁（Large Buy / Sell Wall）
	•	板の移動速度
	•	フェイクウォール検知用データ

⸻

④ デリバティブ指標（Binanceなら必須）
	•	Funding Rate（現在値・履歴）
	•	Open Interest
	•	OIの増減率
	•	ロング/ショート比率
	•	清算データ（Liquidation量・方向）
	•	直近の強制清算発生有無

⸻

⑤ テクニカル指標（AIに生値＋計算値を渡す）
	•	EMA / SMA（複数期間）
	•	RSI
	•	MACD
	•	Bollinger Bands
	•	VWAP
	•	Stochastic
	•	ADX
	•	トレンド強度指標
	•	サポート・レジスタンス候補価格

※「指標名」より
「その数値」＋「どの時間軸か」 を送る方が重要

⸻

⑥ マーケット構造
	•	Higher High / Lower Low 判定
	•	トレンド転換点
	•	レンジ幅
	•	ブレイクアウト有無
	•	フェイクブレイク判定材料

⸻

⑦ 時間・周期性
	•	UTC時刻
	•	取引活発時間帯か否か
	•	ロンドン・NYセッション判定
	•	曜日
	•	月初・月末フラグ

⸻

⑧ マクロ市場影響（暗号全体）
	•	BTCドミナンス
	•	BTC / ETH の直近トレンド
	•	BTCと対象銘柄の相関係数
	•	TOTAL / TOTAL2 の動き
	•	ステーブルコイン供給量変化

⸻

⑨ ニュース・イベント（AIに要約させる用）
	•	直近ニュースの有無
	•	規制関連ニュース
	•	ETF・金利・CPI・FOMCなどのイベント接近フラグ
	•	大規模ハッキング・破綻ニュース

※全文を送る必要はない
→ 要約 or フラグ化が現実的

⸻

⑩ センチメント系（使うなら）
	•	SNSポジティブ/ネガティブ比率
	•	急増ワード
	•	恐怖・強欲指数
	•	Reddit / X の投稿量変化

※ノイズが多い
→ 単体判断には使うな

⸻

⑪ 自分のポジション情報（絶対に送るべき）
	•	現在ポジション有無
	•	Entry価格
	•	含み損益（% / 金額）
	•	保有時間
	•	最大含み益
	•	ストップ位置
	•	トレーリング幅

→ これを送らないAI判断は実戦で無意味

⸻

⑫ 取引制約・ルール
	•	最小ロット
	•	手数料
	•	スリッページ想定
	•	最大許容損失
	•	1トレードあたりリスク%

⸻

⑬ 戦略コンテキスト（超重要）
	•	今は「エントリー判断」か「保有中の出口判断」か
	•	スキャル / デイトレ / スイング
	•	利確優先か、トレンド追従か
	•	「利益が出た時しか売らない」等の制約
」
を
世界中 や、api などから自動取得し、
それをデータとして吐いて
1箇所にデータを集約させ、機械計算nodeに渡します。
そのnodeは、
専属のスコア計算機器(受け取ったら全データからbuyするべきかsellするべきかをスコア化する)がいて、
それらのデータを機械的に処理し、スコアをif (trueならbuysell ,falseなら行動しないなどの、)行動決定を行うn8nの自動化プログラムを作成しています。

機械計算ルール
「機械計算ルールの正解構造（BUY専用）

① まず「ゲート条件（必須通過）」を作る

ここはスコア化しない。
1つでも落ちたら即 NO TRADE。

使う情報：
	•	② 流動性（最低出来高・板厚）
	•	⑭ 実行品質（スプレッド上限）
	•	⑮ リスク制約（DD・同時保有上限）
	•	⑯ データ整合性（欠損・時刻ズレ）
	•	⑨ ニュースの取引停止フラグ

理由
ここをスコアに混ぜると
「条件が悪いのに、他が良くて買う」事故が必ず起きる。

⸻

② 次に「方向性スコア（Trend / Bias）」

順張りか逆張りかの“向き”を決める層

使う情報：
	•	① 価格構造
	•	⑥ マーケット構造
	•	⑱ 市場レジーム
	•	⑧ BTC・市場全体

ルール例（概念）：
	•	上位足（1h/4h/1d）が同方向 → 加点
	•	BTCと強相関かつBTC上昇 → 加点
	•	レンジ判定中 → 減点 or 無効

※ここは±方向スコア
（「どっちに賭けるか」だけを決める）

⸻

③ 次に「タイミングスコア（Entry Timing）」

今入って良いかだけを見る。

使う情報：
	•	⑤ テクニカル
	•	⑦ 時間・セッション
	•	⑥ 転換点/ブレイク情報

ルール例：
	•	トレンド方向＋押し目条件成立 → 加点
	•	高値掴みゾーン → 減点
	•	ロンドン/NY重複時間 → 微加点

※ここは短期足中心（1m〜15m）

⸻

④ 次に「需給スコア（Order / Flow）」

本当に金が入ってきているか

使う情報：
	•	③ オーダーブック
	•	② 出来高変化
	•	④ OI / Funding / 清算

ルール例：
	•	出来高増＋OI増＋価格上 → 強加点
	•	壁が消えながら価格が進む → 加点
	•	Funding極端 → 減点

※ここは嘘シグナル除去が主目的

⸻

⑤ 最後に「ポジション整合スコア」

自分の状態と合っているか

使う情報：
	•	⑪ 自分のポジション情報
	•	⑫ 取引制約
	•	⑮ リスク枠

ルール：
	•	既存ポジと高相関 → 減点 or 禁止
	•	リスク枠内 → 通過
	•	サイズが最小ロット未満 → 無効
核心の一言（忖度なし）
	•	1〜18は「情報量」ではなく「役割」で使え
	•	スコアに入れていいもの／ダメなものを分けない設計は必ず死ぬ
	•	BUYは
①生き残れるか → ②向き → ③今か → ④本物か → ⑤自分に合うか
の順でしか成立しない」
┈┈┈┈┈┈┈┈┈┈

sell ルール

1.	破滅回避ストップ（最優先）への追加・改良

A. Stop判定の価格ソース固定（必須）
	•	トリガー基準は mark price（先物）または index/mark（現物でも取得可能なら代替）を優先
理由：lastは瞬間スパイクで誤爆しやすい。特に板薄い時に死ぬ。

B. スプレッド拡大時の「成行禁止」ルール（必須）
	•	spread_pct > SPREAD_MAX の時は 強制成行SELL禁止、limit か maker に切り替え
	•	ただし「Gap/Shock Stop」だけは例外で成行許可（ただしサイズ縮小）
理由：ストップ時ほどスプレッド拡大で損が増える。ここを無視すると損切りが損切りにならない。

C. 連続ショック停止（キルスイッチ）
	•	shockStop が発動したら cooldown_minutes >= 30 を強制（新規エントリー停止）
	•	同銘柄で shockStop が 2回/60分 起きたら halt_hours = 6
理由：荒れ相場で往復ビンタを防ぐ。損最小に直結。

D. 「滑りすぎ」検知で即停止
	•	想定スリッページ（板から推定）より、実スリッページが x2 を超えたら当日停止
理由：市場状態がロジック前提を破っているサイン。

E. Hard StopとVolatility Stopの統合（パラメータの矛盾排除）
今は固定 -0.60% と ATR連動が併存しているが、銘柄や相場で競合する。以下に統一する。
	•	stop_pct = max(HARD_MIN_STOP, ATR_MULT * ATR_1m_pct + FEE_SLIP_BUFFER)
	•	強制SELL条件：pnl_pct <= -stop_pct
推奨：
	•	HARD_MIN_STOP = 0.45%〜0.75%（銘柄別）
	•	ATR_MULT = 1.1〜1.5
	•	FEE_SLIP_BUFFER = 0.08%〜0.15%（手数料＋平均滑り）
理由：損切り幅は“コスト込み”で設計しないと必ず負ける。

F. Shock Stopの条件補強（誤爆と取り逃しの両方対策）
現状：Δ1m <= -0.35% AND volSpike>=2.5
追加で以下を入れると精度が上がる。
	•	追加条件（どれか1つ満たせばOK）
	•	orderbook_imbalance <= -0.10（売り優勢）
	•	OI_drop_pct が急落（ロング投げの可能性）
	•	long_liq_10m が急増
理由：単なるノイズ下ヒゲを除外しやすい。

⸻

	2.	“撤退”ストップ（損切り嫌いの妥協）への改良

A. Time Stopの「相場レジーム依存」
一律45分は雑。環境で変える。
	•	レンジ：hold >= 20〜35分 AND pnl<0 で撤退
	•	トレンド：hold >= 60〜120分 AND pnl<0 で撤退
理由：トレンドは時間が味方になる時がある。レンジは逆。

B. Entry停止とセット運用を“強制化”
	•	timeStop が発動した銘柄は reentry_block_minutes = 60
	•	同銘柄の timeStop が 2回/1日 で当日停止
理由：損切り回避型は再突入で死ぬ。

C. Regime Stopの定義を「値」ベースで固定
「下向き」だと曖昧なので数値化する。
例（含み損ポジ撤退条件）：
	•	EMA_slope_15m < 0 かつ EMA9_15m < EMA21_15m
	•	さらに HH/LL判定 が Lower High に転じたら即
理由：機械計算に落とすなら曖昧語は全部禁止。

⸻

	3.	利益最大化トレーリング（勝ちを伸ばす）の改良

A. MFEトレールは「コスト込み」に変更（必須）
今の閾値は小さく、手数料と滑りで簡単に期待値が崩れる。
	•	トレール開始条件：mfe >= (FEE_SLIP_BUFFER + START_EDGE)
例：START_EDGE = 0.15%
	•	トレール幅：固定ではなく
trail = max(TRAIL_MIN, TRAIL_ATR_MULT * ATR_1m_pct + FEE_SLIP_BUFFER)
理由：コストを跨いでから“勝ち”が始まる。ここを無視すると「勝ってるのに増えない」。

B. 2段トレールの「広げる」は、相場によっては逆（注意点）
“伸びを殺さない”意図は正しいが、実務では「伸びた後ほど反転が速い」局面もある。だから条件分岐が必要。
	•	mfe>=0.80% で無条件に広げるのではなく
	•	トレンド継続（⑤⑥）＋需給継続（③②）なら広げる
	•	それ以外は むしろ狭める（利益保護）
例：
	•	継続条件：
EMA9_5m > EMA21_5m かつ ADX_5m >= 18 かつ imbalance >= +0.06
	•	継続なら trail_wide、不継続なら trail_tight

C. 「利確停止（売らない）」は危険なので“例外”を必ず付ける
売らない条件を作るなら、同時に「この条件なら売る」を固定で入れる。
例（利確停止中でも売る例外）：
	•	imbalance <= -0.06 へ反転
	•	Δ1m <= -0.25% の急落
	•	long_liq_spike
理由：右肩上がりは永遠に続かない。例外が無いと一撃で戻される。

D. 分割利確（部分決済）を追加（利益最大化の王道）
“全部売る/売らない”は損。
	•	mfe>=0.50% で 30% 部分利確（ただし継続条件が弱い時のみ）
	•	残りはトレールで伸ばす
理由：取り逃しを減らしつつ、伸びも取れる。期待値が安定する。

⸻

	4.	「合理的トリガー（板/流動性）」の改良

A. Orderbook Flipは「持続時間」を入れる（必須）
板はフェイクが多い。瞬間反転で売ると狩られる。
	•	条件：imbalance が閾値を跨いで 連続K回（例：3回=約3〜6秒） 維持したら有効
	•	さらに bid/ask wall の変化が同方向なら確定度UP
理由：フェイクウォールに耐性が付く。

B. 「壁消失」単独は弱いので、出来高と約定をセットにする
	•	bidWallSize 急減 ＋ 直近の taker sell volume 増
で初めて強い売りシグナル
理由：壁が消えるだけなら、単なる更新/ズラしの可能性が高い。

C. 真空（Liquidity Vacuum）の定義を数値化
	•	例：上位N段の合計板厚が medianのX%未満（例：40%未満）
	•	かつ spread_pct 上昇
→ 利益があるなら撤退優先
理由：真空は“逃げ遅れ”が致命傷。

⸻

	5.	先物系データでの撤退の改良

A. 清算は「方向＋価格反応」で決める（重要）
清算量単体は誤判定がある。必ず価格反応とセット。
	•	LONG清算急増 かつ Δ1m<0 かつ imbalance<=-0.06
→ 速攻撤退（利益があるなら即）
理由：崩れは連鎖する。

B. Funding/L-S比は「過熱→即売り」ではなく段階化
	•	過熱域（例：lsr>=1.35 かつ funding高止まり）に入ったら
	•	トレールを狭める（利益保護モード）
	•	板反転/出来高減のトリガー感度を上げる
理由：過熱＝まだ伸びることもある。即売り固定は早売りになる。

C. OIの“増え方”を使う
	•	価格横ばい で OIだけ急増 は危険（溜め込み）
利益があるなら撤退バイアスを上げる
理由：溜め込み後の片方向ブレイクで刈られる。

⸻

	6.	追加で入れるべき「損最小・利益最大化」用の共通補強（重要）

A. パラメータを固定値から「相場適応」にする（必須）
あなたの数値（-0.60%, -0.35%, 0.20% etc）は相場で死ぬ。以下に統一すると強い。
	•	全て ATR%（時間足別） と spread_pct と fee/slip buffer で正規化
例：
	•	shock_threshold = k1 * ATR_1m_pct
	•	trail = k2 * ATR_1m_pct + buffer
	•	timeStop はレジームで可変

B. “手数料・滑り”を考慮した「実効PnL」で判定
	•	effective_pnl = pnl - fee_est - slip_est
トリガー条件は必ず effective_pnl ベースにする
理由：見た目プラスでも実はマイナスが頻発する。

C. 取引後のクールダウン（リベンジ防止）
	•	利確後でも cooldown 1〜5分 を入れる（特にスキャル）
理由：同じノイズ帯で連打すると期待値が崩れる。

D. データ欠損・矛盾時は「保守的に撤退」
	•	③③④など重要データ欠損時は、利益があるなら早め撤退、損なら破滅回避だけ有効
理由：目隠し運転になるのを防ぐ。

E. 1回の売り判断で“二度撃ち”しない（注文状態の管理）
	•	未約定/部分約定中は、売りロジックを一時停止し「注文管理モード」に切替
理由：二重発注で事故る。n8nはここで壊れやすい。

⸻

	7.	改良版の全体像（売りの最終ルール構造）

(1) 強制停止（ゲート）
	•	データ欠損重大 / スプレッド異常 / レート制限 / 異常滑り → 取引停止 or 注文方式変更

(2) 破滅回避ストップ（例外損切りOK）
	•	pnl <= -stop_pct（ATR+コスト込み）
	•	shockStop（価格急落+出来高+需給/清算の補強）
	•	発動後はクールダウン・連続発動でhalt

(3) 撤退ストップ（含み損の泥沼回避）
	•	レジーム別TimeStop＋再エントリー制限
	•	Regime悪化の数値条件

(4) 利益最大化
	•	コスト込みMFEトレール（ATR適応）
	•	継続条件が強い時だけ「利確停止」、ただし例外売りあり
	•	部分利確＋残りトレール

(5) 板・先物データの高精度出口
	•	Flipは持続確認
	•	壁消失は約定/出来高とセット
	•	清算/Funding/LSR/OIは「過熱→保護モード」へ

」

必須
Split in Batches（12銘柄を1つずつ回す）

各銘柄ごとに並列取得（最低でも）

price（last/mark/indexのどれを使うか明記）

candles：1m/5m/15m/1h/4h/1d（intervalごとに別ノード or HTTPでまとめて）

orderbook（depth）

trades or aggTrades

Merge(結合)：上の取得結果を「1アイテムに集約」する（Merge by position / Merge multiple）

Compute Indicators(Code)：ATR/σ/出来高MA/スパイク/imbalance等をここで算出

Gate(Code)：ゲート条件を満たさない場合は即NO_TRADE

Score(Code)：方向/タイミング/需給/整合を別スコアで出す（合算）

Decision(IF)：BUY/SELL/NO

BUYは「実注文ノード」か「HTTP Requestでsigned注文」（Simulate禁止）

SELLも同様（あなたの例外付きルールはここに実装）

さらに spec にこう書く：

“orderbook/tradesが無い場合は必ずNO_TRADEで落とす”

“Mergeせずに$input.first()で済ませるの禁止”

“Simulateは禁止。placeOrder必須”

これで“スケルトン300行”じゃなく、ちゃんと太る。

4) いまのJSONを最低限動くようにするなら（応急処置）

生成器を直す前に動作検証したいなら、最低限これをやる：

fetchSymbols から binanceOrderBook と binanceTrades にも接続する

aggregateData を「4入力を正しくマージ」するコードに変える
例：各入力のjsonを Object.assign で統合（入力が複数枝なので Merge ノードを使う方が安全）

calculateScore の quoteQty 参照は、Binanceのtradesレスポンス形に合わせる
